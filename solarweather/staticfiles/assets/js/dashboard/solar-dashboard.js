// @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
"use strict";import{setup}from"./controls.js";class SolarChartConfig{constructor(){this.config={type:"bar",data:{labels:[],datasets:[{backgroundColor:"#c68200",borderColor:"#FF8C00",data:[]}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{x:{grid:{color:"rgb(255, 255, 255, 0.5)"},ticks:{color:"rgb(255, 255, 255)"}},y:{grid:{color:"rgb(255, 255, 255, 0.5)"},ticks:{color:"rgb(255, 255, 255)"}}}}}}}let Chart;const solarCharts={indoorTemp:{id:"energy-balance-chart",chartObj:null,dataLabel:"grid_power_usage_real"}},updateGraphs=(e,t)=>{solarCharts[e].chartObj.data.labels=t.labels,solarCharts[e].chartObj.data.datasets[0].data=t.values,solarCharts[e].chartObj.update()},formatDate=e=>{const t=[];return new Promise(((r,a)=>{e.labels.forEach((e=>{const r=new Date(1e3*e),a=r.getHours()+":"+("0"+r.getMinutes()).substr(-2);t.push(a)})),r({labels:t,values:e.values})}))},formatTrend=e=>{const t=[],r=[];return new Promise(((a,o)=>{e.forEach((e=>{t.push(e[0]),r.push(-1*e[1])})),a({labels:t,values:r})}))},updateDashboard=e=>{const t=document.getElementById("dashboard-current-usage-card"),r=t.querySelector(".loading-spinner"),a=t.querySelector(".overlay"),o=t.querySelectorAll(".blur"),n=document.getElementById("dashboard-daily-power-card"),s=n.querySelector(".loading-spinner"),l=n.querySelector(".overlay"),d=n.querySelectorAll(".blur"),i=document.getElementById("dashboard-light-card"),c=i.querySelector(".loading-spinner"),u=i.querySelector(".overlay"),p=i.querySelectorAll(".blur"),m=document.getElementById("dashboard-energy-balance-card"),y=m.querySelector(".loading-spinner"),g=m.querySelector(".overlay"),h=m.querySelectorAll(".blur"),b=document.getElementById("current-usage-now"),_=document.getElementById("current-usage-from-solar"),w=document.getElementById("current-usage-from-grid"),v=document.getElementById("generated-day"),E=document.getElementById("generated-week"),f=document.getElementById("generated-month"),C=document.getElementById("used-day"),F=document.getElementById("used-week"),L=document.getElementById("used-month"),x=document.getElementById("uv-index"),B=document.getElementById("light-intensity"),I=e.power_consumption.latest?e.power_consumption.latest:0,S=e.inverter_ac_power.latest?e.inverter_ac_power.latest:0,T=e.grid_power_usage_real.latest?e.grid_power_usage_real.latest:0,q=e.inverter_ac_power.day?e.inverter_ac_power.day:0,H=e.inverter_ac_power.week?e.inverter_ac_power.week:0,M=e.inverter_ac_power.month?e.inverter_ac_power.month:0,k=e.power_consumption.day?e.power_consumption.day:0,N=e.power_consumption.week?e.power_consumption.week:0,j=e.power_consumption.month?e.power_consumption.month:0,D=e.uv_index.latest?e.uv_index.latest:0,O=e.solar_radiation.latest?e.solar_radiation.latest:0,A=Number.parseFloat(I)/1e3,P=Number.parseFloat(S)/1e3,G=Number.parseFloat(T)/1e3,R=Number.parseFloat(q)/1e3,z=Number.parseFloat(H)/1e3,J=Number.parseFloat(M)/1e3,K=Number.parseFloat(k)/1e3,Q=Number.parseFloat(N)/1e3,U=Number.parseFloat(j)/1e3;b.innerHTML=A.toFixed(3),_.innerHTML=P.toFixed(3),w.innerHTML=G.toFixed(3),v.innerHTML=R.toFixed(3),E.innerHTML=z.toFixed(1),f.innerHTML=J.toFixed(1),C.innerHTML=K.toFixed(3),F.innerHTML=Q.toFixed(1),L.innerHTML=U.toFixed(1),x.innerHTML=D,B.innerHTML=O.toFixed(3);for(const t in solarCharts)if({}.hasOwnProperty.call(solarCharts,t)){const r=solarCharts[t].dataLabel;formatTrend(e[r].daily_trend).then(formatDate).then((e=>{updateGraphs(t,e)}))}r.style.display="none",a.style.display="none",o.forEach((e=>{e.classList.remove("blur")})),s.style.display="none",l.style.display="none",d.forEach((e=>{e.classList.remove("blur")})),c.style.display="none",u.style.display="none",p.forEach((e=>{e.classList.remove("blur")})),y.style.display="none",g.style.display="none",h.forEach((e=>{e.classList.remove("blur")}))},getData=()=>{fetch("/dataajax/?dashboard=solar").then((e=>e.json())).then((e=>updateDashboard(e)))};export const init=e=>{Chart=e;const t=new SolarChartConfig;for(const e in solarCharts)({}).hasOwnProperty.call(solarCharts,e)&&(solarCharts[e].chartObj=new Chart(document.getElementById(solarCharts[e].id),t.config));setup(getData),getData()};